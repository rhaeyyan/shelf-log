{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-line me-2"></i>Reading Dashboard</h2>
    <a href="/" class="btn btn-outline-primary">
        <i class="fas fa-arrow-left me-1"></i>Back to Library
    </a>
</div>

<!-- Dashboard Stats -->
<div class="dashboard-stats">
    <div class="stat-card">
        <div class="stat-number">{{ stats.total_books }}</div>
        <div class="stat-label">Total Books</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.finished }}</div>
        <div class="stat-label">Books Read</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.avg_rating }}</div>
        <div class="stat-label">Avg Rating</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.progress_percentage }}%</div>
        <div class="stat-label">Reading Progress</div>
    </div>
</div>

<!-- Status Breakdown -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-tasks me-2"></i>Books by Status
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="display-4 text-warning">{{ stats.to_read }}</div>
                        <div class="text-muted">To Read</div>
                    </div>
                    <div class="col-4">
                        <div class="display-4 text-info">{{ stats.reading }}</div>
                        <div class="text-muted">Reading</div>
                    </div>
                    <div class="col-4">
                        <div class="display-4 text-success">{{ stats.finished }}</div>
                        <div class="text-muted">Finished</div>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 10px;">
                    <div class="progress-bar bg-warning" style="width: {{ (stats.to_read / stats.total_books * 100) if stats.total_books > 0 else 0 }}%"></div>
                    <div class="progress-bar bg-info" style="width: {{ (stats.reading / stats.total_books * 100) if stats.total_books > 0 else 0 }}%"></div>
                    <div class="progress-bar bg-success" style="width: {{ (stats.finished / stats.total_books * 100) if stats.total_books > 0 else 0 }}%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-book me-2"></i>By Format
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <div class="d-flex justify-content-between">
                        <span>Physical</span>
                        <span class="badge bg-secondary rounded-pill">{{ stats.physical_count }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>E-Book</span>
                        <span class="badge bg-secondary rounded-pill">{{ stats.ebook_count }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Audiobook</span>
                        <span class="badge bg-secondary rounded-pill">{{ stats.audiobook_count }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Top Categories and Reading Stats -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-star me-2"></i>Top Categories
            </div>
            <div class="card-body">
                {% if stats.top_categories %}
                    <ul class="list-group list-group-flush">
                        {% for category, count in stats.top_categories %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ category }}
                                <span class="badge bg-primary rounded-pill">{{ count }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted text-center my-3">No categories available</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-pie me-2"></i>Reading Stats
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Highly Rated Books (4-5 stars)</span>
                    <span class="badge bg-primary">{{ stats.high_rated }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Total Pages Read</span>
                    <span class="badge bg-info">{{ stats.total_pages_read }}</span>
                </div>

                <div class="mt-4">
                    <h6>Reading Progress</h6>
                    <div class="progress mb-2" style="height: 10px;">
                        <div class="progress-bar bg-success" style="width: {{ stats.progress_percentage }}%"></div>
                    </div>
                    <div class="text-center">
                        <small>{{ stats.progress_percentage }}% average across all books</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analytics & Insights Section -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i>Reading Statistics
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <div class="text-center">
                        <div class="display-4 text-info">{{ stats.books_per_year|default(0) }}</div>
                        <small class="text-muted">Avg Books/Year</small>
                    </div>
                    <div class="text-center">
                        <div class="display-4 text-success">{{ stats.avg_pages_per_book|default(0) }}</div>
                        <small class="text-muted">Avg Pages/Book</small>
                    </div>
                    <div class="text-center">
                        <div class="display-4 text-warning">{{ stats.avg_days_to_complete|default(0) }}</div>
                        <small class="text-muted">Days/Book</small>
                    </div>
                </div>

                <!-- Reading speed: books per month -->
                <div class="d-flex justify-content-between mb-2">
                    <span>Monthly Reading Rate:</span>
                    <span class="badge bg-info">{{ "%.1f"|format(stats.books_per_month|default(0)) }} books</span>
                </div>

                <!-- Completion rate -->
                <div class="d-flex justify-content-between">
                    <span>Completion Rate:</span>
                    <span class="badge bg-success">{{ "%.1f"|format(stats.completion_rate|default(0)) }}%</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-tags me-2"></i>Favorite Genres Visualization
            </div>
            <div class="card-body">
                <canvas id="genreChart" height="200"></canvas>
                {% if stats.genre_distribution %}
                <div class="mt-3">
                    {% for genre, count in stats.genre_distribution %}
                    <div class="d-flex align-items-center mb-1">
                        <div class="progress flex-grow-1 me-2" style="height: 10px;">
                            <div class="progress-bar bg-primary" role="progressbar"
                                 style="width: {{ (count / stats.total_books * 100)|default(0) }}%"></div>
                        </div>
                        <span class="small">{{ genre }}: {{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center my-3">No genre data to display</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Time-based Reading Analytics -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-calendar-alt me-2"></i>Time-based Reading Analytics
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-clock me-2 text-info"></i>Reading Patterns</h6>
                <div class="d-flex justify-content-between mb-2">
                    <span>Most Active Month:</span>
                    <span class="badge bg-info">{{ stats.most_active_month|default('N/A') }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Peak Reading Season:</span>
                    <span class="badge bg-info">{{ stats.peak_reading_season|default('N/A') }}</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Preferred Weekday:</span>
                    <span class="badge bg-info">{{ stats.preferred_weekday|default('N/A') }}</span>
                </div>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-tachometer-alt me-2 text-success"></i>Reading Speed</h6>
                <div class="d-flex justify-content-between mb-2">
                    <span>Books in Last 30 Days:</span>
                    <span class="badge bg-success">{{ stats.books_last_30_days|default(0) }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Current Reading Pace:</span>
                    <span class="badge bg-success">{{ "%.1f"|format(stats.current_pace|default(0)) }} days/book</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Reading Consistency:</span>
                    <span class="badge bg-success">{{ "%.1f"|format(stats.consistency_score|default(0)) }}%</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Genre Distribution Chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('genreChart').getContext('2d');
    const genreLabels = {{ stats.top_categories_labels|safe if stats.top_categories_labels else [] }};
    const genreData = {{ stats.top_categories_counts|safe if stats.top_categories_counts else [] }};

    if (genreLabels.length > 0 && genreData.length > 0) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: genreLabels,
                datasets: [{
                    label: 'Number of Books',
                    data: genreData,
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}